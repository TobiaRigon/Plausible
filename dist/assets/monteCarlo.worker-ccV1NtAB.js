(function(){"use strict";const y=()=>{let t=0,n=0;for(;t===0;)t=Math.random();for(;n===0;)n=Math.random();return Math.sqrt(-2*Math.log(t))*Math.cos(2*Math.PI*n)},E=(t,n)=>{const l=t.annualReturn/12,o=t.annualVolatility/Math.sqrt(12),u=t.annualFee/12,e=[];let s=t.initialCapital;for(let h=0;h<n;h+=1){const c=y(),r=Math.exp(l-.5*o*o+o*c);s=(s+t.monthlyContribution)*r,s*=1-u,e.push(s)}return{series:e,finalValue:s}},R=t=>{const n=t.reduce((o,u)=>o+u,0);if(n>0)return t.map(o=>o/n);const l=t.length>0?1/t.length:0;return t.map(()=>l)},S=t=>{const n=t.instruments??[],l=t.months,o=1/12,u=t.annualFee/12,e=R(n.map(c=>typeof c.targetWeight=="number"?c.targetWeight:0)),s=n.map((c,r)=>t.initialCapital*e[r]),h=[];for(let c=0;c<l;c+=1){if(n.forEach((r,i)=>{const m=t.monthlyContribution*e[i],M=s[i]+m;if(r.simModel==="rate")s[i]=M*(1+r.mu*o);else{const d=y(),p=(r.mu-.5*r.sigma*r.sigma)*o,a=r.sigma*Math.sqrt(o)*d;s[i]=M*Math.exp(p+a)}s[i]*=1-u}),typeof t.rebalanceIntervalMonths=="number"&&t.rebalanceIntervalMonths>0&&(c+1)%t.rebalanceIntervalMonths===0){const r=s.reduce((i,m)=>i+m,0);s.forEach((i,m)=>{s[m]=r*e[m]})}h.push(s.reduce((r,i)=>r+i,0))}return{series:h,finalValue:h[h.length-1]??0}},f=(t,n)=>{if(t.length===0)return 0;const l=Math.min(Math.max(n,0),100),o=[...t].sort((c,r)=>c-r),u=l/100*(o.length-1),e=Math.floor(u),s=Math.ceil(u);if(e===s)return o[e];const h=u-e;return o[e]*(1-h)+o[s]*h},P=t=>{const n=t.simulations??5e3,l=t.months,o=t.annualInflation??0,u=Array.from({length:l},()=>[]),e=[],h=(t.instruments??[]).length>0&&((t.instruments??[]).some(a=>a.simModel==="rate")||typeof t.rebalanceIntervalMonths=="number"&&t.rebalanceIntervalMonths>0);for(let a=0;a<n;a+=1){const{series:q,finalValue:I}=h?S(t):E(t,l);e.push(I);for(let g=0;g<l;g+=1)u[g].push(q[g]??I);if((a+1)%250===0){const g={type:"progress",id:b,completed:a+1,total:n};postMessage(g)}}const c=u.map(a=>({p10:f(a,10),p50:f(a,50),p90:f(a,90)})),r={p10:f(e,10),p50:f(e,50),p90:f(e,90)},i=o===0?1:Math.pow(1+o,l/12),m=i===1?e:e.map(a=>a/i),M={p10:f(m,10),p50:f(m,50),p90:f(m,90)},d=t.threshold,p=typeof d=="number"&&n>0?e.filter(a=>a>=d).length/n:0;return{finalDistribution:e,seriesPercentiles:c,summary:{nominal:r,real:M,probabilityAboveThreshold:p}}};let b=0;self.onmessage=t=>{if(t.data.type==="run"){b=t.data.id;try{const n=P(t.data.params),l={type:"result",id:t.data.id,result:n};postMessage(l)}catch(n){const l={type:"error",id:t.data.id,message:n instanceof Error?n.message:"Simulation error"};postMessage(l)}}}})();
